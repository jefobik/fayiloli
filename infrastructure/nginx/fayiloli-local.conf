# ─────────────────────────────────────────────────────────────────────────────
# Nginx — LOCAL DEVELOPMENT
# Fayiloli EDMS  ·  Wildcard *.localhost  ·  No SSL
#
# Prerequisites:
#   /etc/hosts entries for each tenant:
#     127.0.0.1  localhost          ← central admin
#     127.0.0.1  finance.localhost  ← tenant workspace
#     127.0.0.1  hra.localhost      ← tenant workspace
#
# Install:
#   sudo cp infrastructure/nginx/fayiloli-local.conf /etc/nginx/sites-available/fayiloli
#   sudo ln -sf /etc/nginx/sites-available/fayiloli /etc/nginx/sites-enabled/fayiloli
#   sudo nginx -t && sudo systemctl reload nginx
#
# Usage with php artisan serve:
#   For local dev, `php artisan serve --host=0.0.0.0 --port=8000` is sufficient.
#   This Nginx config is only needed when you want to serve on port 80 without
#   the `:8000` suffix.
# ─────────────────────────────────────────────────────────────────────────────

# ── Central admin: http://localhost ──────────────────────────────────────────
server {
    listen 80;
    server_name localhost 127.0.0.1;

    root /var/www/laravel/fayiloli/public;
    index index.php;

    # Logging
    access_log /var/log/nginx/fayiloli-central-access.log;
    error_log  /var/log/nginx/fayiloli-central-error.log;

    # PHP-FPM (adjust socket/port to match your setup)
    location ~ \.php$ {
        include        snippets/fastcgi-php.conf;
        fastcgi_pass   unix:/run/php/php8.3-fpm.sock;
        fastcgi_param  SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include        fastcgi_params;
    }

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 7d;
        access_log off;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}

# ── Tenant workspaces: http://*.localhost ─────────────────────────────────────
#
# NOTE: Nginx does NOT support wildcard in server_name for arbitrary subdomains
# without a DNS resolver that returns them.  On local dev you must add a
# /etc/hosts entry for each tenant subdomain.  The _ catch-all below handles
# requests where Nginx receives a Host header not matched by a more specific
# server block — this works because your /etc/hosts routes *.localhost → 127.0.0.1
# and Nginx then serves the app which initialises tenancy by domain.
#
server {
    listen 80 default_server;
    server_name _;    # catch-all: all *.localhost entries from /etc/hosts

    root /var/www/laravel/fayiloli/public;
    index index.php;

    access_log /var/log/nginx/fayiloli-tenant-access.log;
    error_log  /var/log/nginx/fayiloli-tenant-error.log;

    location ~ \.php$ {
        include        snippets/fastcgi-php.conf;
        fastcgi_pass   unix:/run/php/php8.3-fpm.sock;
        fastcgi_param  SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include        fastcgi_params;
    }

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 7d;
        access_log off;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}
