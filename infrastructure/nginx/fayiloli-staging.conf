# ─────────────────────────────────────────────────────────────────────────────
# Nginx — VPS STAGING
# Fayiloli EDMS  ·  Wildcard *.staging.fayiloli.ng  ·  Let's Encrypt SSL
#
# Prerequisites:
#   1. DNS wildcard record pointing to this server:
#        *.staging.fayiloli.ng  A  <SERVER_IP>
#         staging.fayiloli.ng   A  <SERVER_IP>   ← central admin
#
#   2. Wildcard SSL certificate obtained via Certbot DNS challenge:
#        sudo certbot certonly --dns-cloudflare \
#          --dns-cloudflare-credentials /etc/letsencrypt/cloudflare.ini \
#          -d "*.staging.fayiloli.ng" \
#          -d "staging.fayiloli.ng"
#      Cert paths (used below):
#        /etc/letsencrypt/live/staging.fayiloli.ng/fullchain.pem
#        /etc/letsencrypt/live/staging.fayiloli.ng/privkey.pem
#
#   3. .env values on staging server:
#        DEPLOYMENT_ENV=staging
#        TENANT_BASE_DOMAIN=fayiloli.ng
#        CENTRAL_DOMAIN=admin.staging.fayiloli.ng
#        APP_URL=https://admin.staging.fayiloli.ng
#
# Install:
#   sudo cp infrastructure/nginx/fayiloli-staging.conf /etc/nginx/sites-available/fayiloli
#   sudo ln -sf /etc/nginx/sites-available/fayiloli /etc/nginx/sites-enabled/fayiloli
#   sudo nginx -t && sudo systemctl reload nginx
# ─────────────────────────────────────────────────────────────────────────────

# ── HTTP → HTTPS redirect (all hosts) ─────────────────────────────────────────
server {
    listen 80;
    server_name .staging.fayiloli.ng;  # matches *.staging.fayiloli.ng + staging.fayiloli.ng

    # Allow Let's Encrypt HTTP-01 challenges (used by certbot auto-renewal).
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# ── Central admin: https://admin.staging.fayiloli.ng ─────────────────────────
server {
    listen 443 ssl;
    http2 on;
    server_name admin.staging.fayiloli.ng;

    root /var/www/laravel/fayiloli/public;
    index index.php;

    # ── TLS ─────────────────────────────────────────────────────────────────
    ssl_certificate     /etc/letsencrypt/live/staging.fayiloli.ng/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/staging.fayiloli.ng/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_stapling        on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/staging.fayiloli.ng/chain.pem;
    resolver 8.8.8.8 1.1.1.1 valid=300s;
    resolver_timeout 5s;

    # ── Security headers ─────────────────────────────────────────────────────
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains" always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # ── Logging ──────────────────────────────────────────────────────────────
    access_log /var/log/nginx/fayiloli-staging-central-access.log;
    error_log  /var/log/nginx/fayiloli-staging-central-error.log;

    # ── PHP-FPM ──────────────────────────────────────────────────────────────
    location ~ \.php$ {
        include        snippets/fastcgi-php.conf;
        fastcgi_pass   unix:/run/php/php8.3-fpm.sock;
        fastcgi_param  SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include        fastcgi_params;

        # Forward the real host so tenancy can identify the domain.
        fastcgi_param  HTTP_HOST $host;
    }

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}

# ── Tenant workspaces: https://*.staging.fayiloli.ng ─────────────────────────
#
# A single wildcard server block handles ALL tenant subdomains.
# stancl/tenancy's InitializeTenancyByDomain reads $request->getHost()
# and looks up the matching tenant from the domains table.
#
server {
    listen 443 ssl default_server;
    http2 on;
    server_name *.staging.fayiloli.ng;

    root /var/www/laravel/fayiloli/public;
    index index.php;

    # ── TLS (same wildcard cert covers all *.staging.fayiloli.ng) ───────────
    ssl_certificate     /etc/letsencrypt/live/staging.fayiloli.ng/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/staging.fayiloli.ng/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_stapling        on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/staging.fayiloli.ng/chain.pem;
    resolver 8.8.8.8 1.1.1.1 valid=300s;
    resolver_timeout 5s;

    # ── Security headers ─────────────────────────────────────────────────────
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains" always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # ── Logging ──────────────────────────────────────────────────────────────
    access_log /var/log/nginx/fayiloli-staging-tenant-access.log;
    error_log  /var/log/nginx/fayiloli-staging-tenant-error.log;

    # ── PHP-FPM ──────────────────────────────────────────────────────────────
    location ~ \.php$ {
        include        snippets/fastcgi-php.conf;
        fastcgi_pass   unix:/run/php/php8.3-fpm.sock;
        fastcgi_param  SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include        fastcgi_params;

        # Forward the real host so tenancy can identify the tenant.
        fastcgi_param  HTTP_HOST $host;
    }

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}
