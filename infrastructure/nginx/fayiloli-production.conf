# ─────────────────────────────────────────────────────────────────────────────
# Nginx — PRODUCTION
# Fayiloli EDMS  ·  Wildcard *.fayiloli.ng  ·  Let's Encrypt SSL
#
# Prerequisites:
#   1. DNS wildcard record pointing to this server:
#        *.fayiloli.ng   A  <SERVER_IP>
#          fayiloli.ng   A  <SERVER_IP>   ← apex (redirects to central admin)
#
#   2. Wildcard SSL certificate obtained via Certbot DNS challenge:
#        sudo certbot certonly --dns-cloudflare \
#          --dns-cloudflare-credentials /etc/letsencrypt/cloudflare.ini \
#          -d "*.fayiloli.ng" \
#          -d "fayiloli.ng"
#      Cert paths:
#        /etc/letsencrypt/live/fayiloli.ng/fullchain.pem
#        /etc/letsencrypt/live/fayiloli.ng/privkey.pem
#
#   3. .env values on production server:
#        DEPLOYMENT_ENV=production
#        TENANT_BASE_DOMAIN=fayiloli.ng
#        CENTRAL_DOMAIN=admin.fayiloli.ng
#        APP_URL=https://admin.fayiloli.ng
#        APP_DEBUG=false
#        APP_ENV=production
#
# Install:
#   sudo cp infrastructure/nginx/fayiloli-production.conf /etc/nginx/sites-available/fayiloli
#   sudo ln -sf /etc/nginx/sites-available/fayiloli /etc/nginx/sites-enabled/fayiloli
#   sudo nginx -t && sudo systemctl reload nginx
#
# Certbot auto-renewal:
#   sudo crontab -e
#   0 2 * * * certbot renew --quiet --post-hook "systemctl reload nginx"
# ─────────────────────────────────────────────────────────────────────────────

# ── HTTP → HTTPS redirect (all hosts) ─────────────────────────────────────────
server {
    listen 80;
    server_name .fayiloli.ng;   # matches *.fayiloli.ng + fayiloli.ng

    # Allow Let's Encrypt HTTP-01 challenges (auto-renewal).
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# ── Apex redirect: https://fayiloli.ng → https://admin.fayiloli.ng ────────────
server {
    listen 443 ssl;
    http2 on;
    server_name fayiloli.ng;

    ssl_certificate     /etc/letsencrypt/live/fayiloli.ng/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/fayiloli.ng/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;

    return 301 https://admin.fayiloli.ng$request_uri;
}

# ── Central admin: https://admin.fayiloli.ng ──────────────────────────────────
server {
    listen 443 ssl;
    http2 on;
    server_name admin.fayiloli.ng;

    root /var/www/laravel/fayiloli/public;
    index index.php;

    # ── TLS ─────────────────────────────────────────────────────────────────
    ssl_certificate     /etc/letsencrypt/live/fayiloli.ng/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/fayiloli.ng/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;
    ssl_session_cache   shared:SSL:20m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;
    ssl_stapling        on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/fayiloli.ng/chain.pem;
    resolver 8.8.8.8 1.1.1.1 valid=300s;
    resolver_timeout 5s;

    # ── Security headers ─────────────────────────────────────────────────────
    # HSTS — 2-year max-age, includeSubDomains + preload (submit to
    # https://hstspreload.org after confirming all subdomains are HTTPS)
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;
    # CSP — tighten as needed for your JS/CSS sources
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'none';" always;

    # ── Upload / body limits ─────────────────────────────────────────────────
    client_max_body_size 50M;

    # ── Rate limiting (define zone in nginx.conf http block) ─────────────────
    # limit_req zone=fayiloli_central burst=20 nodelay;

    # ── Logging ──────────────────────────────────────────────────────────────
    access_log /var/log/nginx/fayiloli-prod-central-access.log combined buffer=16k;
    error_log  /var/log/nginx/fayiloli-prod-central-error.log warn;

    # ── PHP-FPM ──────────────────────────────────────────────────────────────
    location ~ \.php$ {
        include        snippets/fastcgi-php.conf;
        fastcgi_pass   unix:/run/php/php8.3-fpm.sock;
        fastcgi_param  SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include        fastcgi_params;

        fastcgi_param  HTTP_HOST $host;
        fastcgi_read_timeout 300;
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
    }

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Static assets — long-lived cache with immutable flag
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|map)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Block hidden files / dotfiles
    location ~ /\.(?!well-known).* {
        deny all;
    }

    # Block sensitive Laravel internals
    location ~ ^/(storage/framework|bootstrap/cache|vendor)/ {
        deny all;
    }
}

# ── Tenant workspaces: https://*.fayiloli.ng ──────────────────────────────────
#
# One wildcard server block serves ALL tenant subdomains.
# stancl/tenancy's InitializeTenancyByDomain middleware reads $host,
# looks up the tenant in the domains table, and switches the DB connection.
#
# Security notes:
#   • Tenants are isolated at the database level (separate PostgreSQL DB per tenant).
#   • DNS wildcard covers only registered subdomains — unregistered FQDNs return 404
#     (InitializeTenancyByDomain::$onFail → abort(404) for unknown domains).
#   • HSTS prevents SSL stripping on known subdomains.
#   • Each tenant's session is scoped to their subdomain (SESSION_DOMAIN is not set,
#     so the browser scopes cookies to the exact host).
#
server {
    listen 443 ssl default_server;
    http2 on;
    server_name *.fayiloli.ng;

    root /var/www/laravel/fayiloli/public;
    index index.php;

    # ── TLS (same wildcard cert) ─────────────────────────────────────────────
    ssl_certificate     /etc/letsencrypt/live/fayiloli.ng/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/fayiloli.ng/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;
    ssl_session_cache   shared:SSL:20m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;
    ssl_stapling        on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/fayiloli.ng/chain.pem;
    resolver 8.8.8.8 1.1.1.1 valid=300s;
    resolver_timeout 5s;

    # ── Security headers ─────────────────────────────────────────────────────
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;

    # ── Upload / body limits ─────────────────────────────────────────────────
    client_max_body_size 100M;   # EDMS document uploads

    # ── Rate limiting ─────────────────────────────────────────────────────────
    # limit_req zone=fayiloli_tenant burst=30 nodelay;

    # ── Logging ──────────────────────────────────────────────────────────────
    access_log /var/log/nginx/fayiloli-prod-tenant-access.log combined buffer=16k;
    error_log  /var/log/nginx/fayiloli-prod-tenant-error.log warn;

    # ── PHP-FPM ──────────────────────────────────────────────────────────────
    location ~ \.php$ {
        include        snippets/fastcgi-php.conf;
        fastcgi_pass   unix:/run/php/php8.3-fpm.sock;
        fastcgi_param  SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include        fastcgi_params;

        # Critical: forward $host so Laravel/tenancy sees the tenant subdomain.
        fastcgi_param  HTTP_HOST $host;
        fastcgi_read_timeout 300;
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
    }

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|map)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }

    location ~ ^/(storage/framework|bootstrap/cache|vendor)/ {
        deny all;
    }
}

# ─────────────────────────────────────────────────────────────────────────────
# Rate limiting zones — add these to your /etc/nginx/nginx.conf http {} block:
#
#   limit_req_zone $binary_remote_addr zone=fayiloli_central:10m rate=10r/s;
#   limit_req_zone $binary_remote_addr zone=fayiloli_tenant:10m  rate=20r/s;
#
# ─────────────────────────────────────────────────────────────────────────────
